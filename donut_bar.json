{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "description": "Top-N Countries filtered by Super Region via dropdown, coloured by mode (Air/Sea/Land).",
  "data": {"url": "output/tourism_flow_region_country_poe_state_year.csv", "format": {"type": "csv"}},
  "background": "transparent",
  "view": {"stroke": "transparent "},

  "params": [
    {
      "name": "superChoice",
      "value": "All",
      "bind": {"input": "select", "options": ["All", "Asia", "Europe", "Others"], "name": "Super Region: "}
    },
    {"name": "TOP_N", "value": 3}
  ],
  "padding":{ "top":10, "left":50, "right":0, "bottom":10},
  "width": 700,
  "height": 200,
  

  "transform": [
    {
      "calculate": "(test(datum.region, /Asia/) || datum.region=='ASEAN') ? 'Asia' : (datum.region=='Europe' ? 'Europe' : 'Others')",
      "as": "super_region"
    },
    {"filter": "superChoice == 'All' || datum.super_region == superChoice"},
    {"calculate": "slice(datum.country_label, 0, 15)", "as": "country_label"},

    {
      "lookup": "poe",
      "from": {
        "data": {"url": "https://raw.githubusercontent.com/jxxjx/FIT3179_Week10_Homework/main/poe.csv", "format": {"type": "csv"}},
        "key": "poe",
        "fields": ["type"]
      }
    },

    {
      "aggregate": [{"op": "sum", "field": "total_arrivals", "as": "Total"}],
      "groupby": ["country_label", "super_region", "type"]
    },

    
    {
      "joinaggregate": [{"op": "sum", "field": "Total", "as": "TotalCountry"}],
      "groupby": ["country_label", "super_region"]
    },

   
    {
      "window": [{"op": "dense_rank", "as": "country_rank"}],
      "sort": [{"field": "TotalCountry", "order": "descending"}]
    },

   
    {"filter": "datum.country_rank <= TOP_N"}
  ],

  "mark": {"type": "bar", "cornerRadiusEnd": 4},

  "encoding": {
    "y": {
      "field": "country_label",
      "type": "nominal",
      "sort": "-x",
      "axis": {"title": null, "labelLimit": 150, "labelAlign": "right"}
    },
    "x": {
      "field": "Total",
      "type": "quantitative",
      "axis": {"title": null, "format": "s"},
      "stack": "zero"
    },
    "color": {
      "field": "type",
      "type": "nominal",
      "title": "Mode",
      "scale": {"domain": ["Air", "Sea", "Land"], "range": ["#8CCDEB", "#131D4F", "#541212"]},
      "legend": null
    },
    "tooltip": [
      {"field": "country_label", "title": "Country"},
      {"field": "super_region", "title": "Super Region"},
      {"field": "type", "title": "Mode"},
      {"field": "Total", "type": "quantitative", "title": "Arrivals (this mode)", "format": ","},
      {"field": "TotalCountry", "type": "quantitative", "title": "Total Arrivals (all modes)", "format": ","}
    ]
  },

  "config": {
    "background": "white",
    "axis": {"labelFontSize": 12, "titleFontSize": 12, "domain": false, "grid": false},
    "labelFontSize": 10
  }
}
