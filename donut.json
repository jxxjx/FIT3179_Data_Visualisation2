{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "background": "transparent",
  "width": 300, "height": 300,

  "data": {
    "url": "foreign_arrivals.csv",
    "format": {
      "type": "csv",
      "parse": {
        "date": "date",
        "arrivals_male": "number",
        "arrivals_female": "number"
      }
    }
  },

  "params": [
    {
      "name": "selectYear",
      "bind": {"input": "range", "min": 2020, "max": 2023, "step": 1, "name": "Year: "},
      "value": 2020
    },
    {
      "name": "selectCountry",
      "bind": {"input": "select", "name": "Country: ",
        "options": ["All","AFG","MYS","SGP","THA","IDN","CHN","BRN"]},
      "value": "All"
    }
  ],

  "transform": [
    {"calculate": "year(toDate(datum.date))", "as": "yr"},
    {"filter": "datum.yr == selectYear"},
    {"filter": "selectCountry == 'All' || datum.country == selectCountry"},

    {"fold": ["arrivals_male","arrivals_female"], "as": ["gender_key","count"]},
    {"aggregate": [{"op":"sum","field":"count","as":"total"}], "groupby": ["gender_key"]},
    {"filter": "isValid(datum.total) && datum.total > 0"},
    {"calculate": "datum.gender_key == 'arrivals_male' ? 'Male' : 'Female'", "as": "Gender"},


    {"joinaggregate": [{"op":"sum","field":"total","as":"grand_total"}]},

    {"calculate": "round(datum.total / datum.grand_total * 100, 1)", "as": "pct"},
    {"calculate": "format(datum.pct, '.1f') + '%'", "as": "pct_label"}
  ],

  "layer": [
    {
      "mark": {"type": "arc", "innerRadius": 90, "stroke": "#fff", "strokeWidth": 2},
      "encoding": {
        "theta": {"field": "total", "type": "quantitative"},
        "color": {
          "field": "Gender",
          "type": "nominal",
          "scale": {"range": ["#2B6CB0","#E53E3E"]},
          "legend": {"title": "Gender", "orient": "bottom", "direction": "horizontal"}
        },
        "tooltip": [
          {"field": "Gender"},
          {"field": "total", "title": "Arrivals", "format": ","},
          {"field": "pct", "title": "Percentage (%)", "format": ".1f"}
        ]
      }
    }
  ],

  "view": {"stroke": "transparent"},
  "config": {
    "legend": {"titleFontSize": 14, "labelFontSize": 12,"orient":"right" } 
  }

}
